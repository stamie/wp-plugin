<?php


/** Loads the WordPress Environment and Template */
require __DIR__ . '/../../../../wp-config.php';
//require_once __DIR__ . '/xmlPortSyncFunctions.php';
?>
<div class="acordion-panel">
    <button class="help accordion help-xml-port"> </button>
    <div class="panel">
        <div class="helper-background">
            <h1><span>XML csat. kik&ouml;t&#337;k - v&aacute;ros p&aacute;ros&iacute;t&aacute;s </span></h1>
            <ol start="1">
                <li><span>XML csatorn&aacute;b&oacute;l bet&ouml;lt&ouml;tt kik&ouml;t&#337; neve. Saj&aacute;t linkkel van ell&aacute;tva ami &aacute;tvisz a Google t&eacute;rk&eacute;pen a poz&iacute;ci&oacute;j&aacute;ra. Megmutatja melyik v&aacute;rosban tal&aacute;lhat&oacute; &eacute;s mi a v&aacute;ros sz&eacute;less&eacute;gi &eacute;s hossz&uacute;s&aacute;gi foka.<br></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 126.00px; height: 21.00px;"><img alt="" src="/wp-content/plugins/boat-shortcodes/admin/images/image11.png" style="width: 126.00px; height: 21.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);"></span></li>
                <li><span>A XML csatorn&aacute;b&oacute;l bet&ouml;lt&ouml;tt kik&ouml;t&#337;h&ouml;z hozz&aacute; lett p&aacute;ros&iacute;tva megfelel&#337; v&aacute;ros (&bdquo;V&aacute;ros lista&rdquo; oszlop).<br>Az </span><b>&ouml;sszek&ouml;t&eacute;st</b><span>&nbsp;a leg&ouml;rd&uuml;l&#337; men&uuml; </span><span>z&ouml;ld</span><span>&nbsp;h&aacute;ttere jelzi.<br></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 263.00px; height: 28.00px;"><img alt="" src="/wp-content/plugins/boat-shortcodes/admin/images/image10.png" style="width: 263.00px; height: 28.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);"></span></li>
                <li><span>A XML csatorn&aacute;b&oacute;l bet&ouml;lt&ouml;tt kik&ouml;t&#337;h&ouml;z nem lett m&eacute;g hozz&aacute; p&aacute;ros&iacute;tva megfelel&#337; v&aacute;ros (&bdquo;V&aacute;ros lista&rdquo; oszlop).<br>Az </span><b>nem&nbsp;&ouml;sszek&ouml;t&eacute;st</b><span>&nbsp;a leg&ouml;rd&uuml;l&#337; men&uuml; </span><span>sz&uuml;rke</span><span>&nbsp;h&aacute;ttere jelzi.<br></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 262.00px; height: 29.00px;"><img alt="" src="/wp-content/plugins/boat-shortcodes/admin/images/image13.png" style="width: 262.00px; height: 29.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);"></span></li>
                <li><span>A kiv&aacute;lasztott kik&ouml;t&#337; </span><span>hozz&aacute;rendel&eacute;se</span><span>&nbsp;ut&aacute;ni ment&eacute;s.<br></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 97.00px; height: 30.00px;"><img alt="" src="/wp-content/plugins/boat-shortcodes/admin/images/image12.png" style="width: 97.00px; height: 30.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);"></span></li>
                <li><span>Ha nincs benne a v&aacute;ros a kiv&aacute;laszthat&oacute; list&aacute;ban, akkor azt az &bdquo;&Uacute;j v&aacute;ros hozz&aacute;rendel&eacute;se&rdquo; gombbal lehet felvinni.<br></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 169.00px; height: 33.00px;"><img alt="" src="/wp-content/plugins/boat-shortcodes/admin/images/image15.png" style="width: 169.00px; height: 33.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);"></span></li>
                <li><span>Az &bdquo;&Uacute;j v&aacute;ros hozz&aacute;rendel&eacute;se&rdquo; r&eacute;szleteiben meg kell adni a v&aacute;ros nev&eacute;t, sz&eacute;less&eacute;gi &eacute;s hossz&uacute;s&aacute;gi fokait. <br></span><span class="c9">(A kik&ouml;t&#337; linkj&eacute;n el&eacute;rhet&#337; a Google t&eacute;rk&eacute;pen.)<br></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 506.00px; height: 33.00px;"><img alt="" src="/wp-content/plugins/boat-shortcodes/admin/images/image14.png" style="width: 506.00px; height: 33.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);"></span></li>
            </ol>
            <p class="c8 c10"></p>
            <link href="/wp-content/plugins/boat-shortcodes/admin/css/select2.css" rel="stylesheet" />
            <script src="/wp-content/plugins/boat-shortcodes/admin/js/select2.full.js" type="text/javascript"></script>
        </div>
    </div>
</div>
<?php

global $wpdb;

$slug =  isset($_POST['slug']) ? $_POST['slug'] : 0;
$query = "select id from xml where slug like '$slug'";
$rows = $wpdb->get_results($query, OBJECT);
$xml_id = 0;
if (is_array($rows) && count($rows) > 0) {
    $xml_id = $rows[0]->id;
}
$query = "select id from table_prefix where prefix like '{$wpdb->prefix}'";
$rows = $wpdb->get_results($query, OBJECT);
$prefix_id = 0;
if (is_array($rows) && count($rows) > 0) {
    $prefix_id = $rows[0]->id;
}

$queryPorts = "SELECT p.name name_, p.xml_lat lat, p.xml_long lon, p.xml_json_id port_id FROM port as p WHERE p.xml_id = $xml_id 
                GROUP by p.name, p.xml_json_id, p.xml_lat, p.xml_long ORDER BY name_ ASC";

$rowsPorts = $wpdb->get_results($queryPorts, OBJECT);
//var_dump("SELECT xml_json_port_id port_id, cities_id city from ports_in_cities where xml_id = $xml_id and $prefix_id = wp_prefix_id ");
$selectedCities = $wpdb->get_results("SELECT pic.xml_json_port_id port_id, pic.cities_id city from ports_in_cities pic inner join cities c on c.id = pic.cities_id where pic.xml_id = $xml_id and $prefix_id = pic.wp_prefix_id and pic.cities_id is not null", ARRAY_A);
if ($selectedCities == null){
    $selectedCities = array();
}
$green_ports = $wpdb->get_results("SELECT pic.xml_json_port_id port_id from ports_in_cities pic inner join cities c on c.id = pic.cities_id where pic.xml_id = $xml_id and $prefix_id = pic.wp_prefix_id and pic.cities_id is not null", ARRAY_A);

if ($green_ports == null){
    $green_ports = array();
}
$queryCities = "SELECT c.id ID, c.name name_, c.lat lat, c.lon lon from cities c order by name_ asc";
$rowsCities = $wpdb->get_results($queryCities, OBJECT);

if (is_array($rowsPorts) && count($rowsPorts) > 0) :

?>
    <table class="xml-port-sync">
        <tr>
            <th><?php echo $slug; ?>-ból vett kikötők</th>
            <th>Város lista (bővíthető)</th>
            <th>Műveletek</th>
        </tr>
        <?php
        foreach ($rowsPorts as $port) :
        ?>
            <tr>
                <td><a target="_blank" href="https://www.google.hu/maps/place/<?php echo $port->lat; ?>,<?php echo $port->lon; ?>"><?php echo $port->name_; ?></a></td>
                <?php
                if (is_array($rowsCities) && count($rowsCities)) :
                    $green = in_array(array("port_id" => $port->port_id), $green_ports);
                ?>
                    <td>
                        <div class="select<?php echo ($green) ? ' selected-option' : ''; ?>">
                            <select class="<?php echo ($green) ? ' selected-option ' : ''; ?> city" id="<?php echo $port->port_id; ?>_<?php echo $xml_id; ?>_<?php echo $prefix_id; ?>" attr-port="<?php echo $port->port_id; ?>" attr-xml="<?php echo $xml_id; ?>" attr-wp="<?php echo $prefix_id; ?>">
                                <?php foreach ($rowsCities as $city) : ?>
                                    <option value="0" >Nincs megadva város</option>
                                    <?php $selectedCity = in_array(array("port_id" => $port->port_id, "city" => $city->ID), $selectedCities); ?>
                                    <option attr-lat=<?php echo $city->lat; ?> attr-lon=<?php echo $city->lon; ?> value="<?php echo $city->ID; ?>" <?php echo ($selectedCity) ? ' selected="selected"' : ''; ?>><?php echo $city->name_; ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>

                        <script>
                            $("#<?php echo $port->port_id; ?>_<?php echo $xml_id; ?>_<?php echo $prefix_id; ?>").select2();
                        </script>
                    </td>
                    <td>
                        <button class="submit-city button" attr-port="<?php echo $port->port_id; ?>" attr-xml="<?php echo $xml_id; ?>" attr-wp="<?php echo $prefix_id; ?>">OK</button>
                        <button class="new-city button" attr-port="<?php echo $port->port_id; ?>" attr-xml="<?php echo $xml_id; ?>" attr-wp="<?php echo $prefix_id; ?>">Új város</button>
                        <button class="repear-city button" attr-port="<?php echo $port->port_id; ?>" attr-xml="<?php echo $xml_id; ?>" attr-wp="<?php echo $prefix_id; ?>" attr-city="<?php echo $selectedCity ? $selectedCity->id : "0"; ?>">Javítás</button>
                        <button class="delete-city button" attr-port="<?php echo $port->port_id; ?>" attr-xml="<?php echo $xml_id; ?>" attr-wp="<?php echo $prefix_id; ?>" attr-city="<?php echo $selectedCity ? $selectedCity->id : "0"; ?>">V. törlés</button>
                        <button class="reset-city button" attr-port="<?php echo $port->port_id; ?>" attr-xml="<?php echo $xml_id; ?>" attr-wp="<?php echo $prefix_id; ?>">Visszaállítás</button>
                    </td>
                <?php else : ?>
                    <td colspan="2"><?php echo __('NINCS AJÁNLOTT VÁROS', 'boat-shortcodes'); ?></td>
                <?php endif; ?>

            </tr>
        <?php
        endforeach;
        ?>
    </table>
<?php
endif;
?>


<script>
    var acc = document.getElementsByClassName("help-xml-port");
    var i;

    for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.maxHeight) {
                panel.style.maxHeight = null;
            } else {
                panel.style.maxHeight = panel.scrollHeight + "px";
            }
        });
    }

    jQuery("select.city").on("change", function() {
        var city = jQuery(this).val();
        var lat = 0;
        var lon = 0;
        var html = "0";
        var options = jQuery(this).children("option");
        options.each(function() {
            if (city == jQuery(this).attr("value")) {
                lat = jQuery(this).attr("attr-lat");
                lon = jQuery(this).attr("attr-lon");
                html = jQuery(this).html();

            }
        });
        var repear = jQuery(this).parents("td").first().next().children(".repear-city").first();
        repear.attr("attr-city", city);
        repear.attr("attr-lat", lat);
        repear.attr("attr-lon", lon);
        repear.attr("attr-name", html);

        var delete_ = jQuery(this).parents("td").first().next().children(".delete-city").first();
        delete_.attr("attr-city", city);
        delete_.attr("attr-lat", lat);
        delete_.attr("attr-lon", lon);
        delete_.attr("attr-name", html);

    });
    //Város jóváhagyása
    jQuery(".submit-city").on('click', function() {
        var port_id = jQuery(this).attr("attr-port");
        var xml_id = jQuery(this).attr("attr-xml");
        var wp_id = jQuery(this).attr("attr-wp");
        var city_id = 0;
        var selectedOption = null;
        jQuery("select").each(function() {

            if (jQuery(this).attr("attr-port") == port_id &&
                jQuery(this).attr("attr-xml") == xml_id &&
                jQuery(this).attr("attr-wp") == wp_id
            ) {
                city_id = jQuery(this).val();
                selectedOption = jQuery(this);
            }
        });
        if (city_id > 0) {

            jQuery.ajax({
                url: "/wp-content/plugins/boat-shortcodes/admin/ajaxSubmitCity.php",
                method: 'POST',
                data: {
                    'city': city_id,
                    'port': port_id,
                    'xml': xml_id,
                    'wp': wp_id
                }
            }).done(function(msg) {
                console.log(msg);
                if (msg == 1) {
                    selectedOption.addClass('selected-option');
                    console.log(selectedOption.parent().find('select2-selection__rendered'));
                    selectedOption.parent().find('select2-selection__rendered').addClass('selected-option');
                    selectedOption.parents('td').css('background-color', 'green');

                } else {
                    alert(msg);
                }

            });
        }

    });
    jQuery("select.city").trigger("change");
    //Alaphelyzetbe állítás
    jQuery(".reset-city").on('click', function() {
        var port_id = jQuery(this).attr("attr-port");
        var xml_id = jQuery(this).attr("attr-xml");
        var wp_id = jQuery(this).attr("attr-wp");
        var resetButton = jQuery(this);

        jQuery.ajax({
            url: "/wp-content/plugins/boat-shortcodes/admin/ajaxResetCity.php",
            method: 'POST',
            data: {
                'port': port_id,
                'xml': xml_id,
                'wp': wp_id,
                'who': 'xml'
            }
        }).done(function(msg) {
            if (msg == 1) {
                console.log(resetButton.parents('tr').find('td'));
                resetButton.parents('tr').find('td').css('background-color', 'white');
                console.log(resetButton.parents('tr').find('.selected-option'));
                resetButton.parents('tr').find('.selected-option').removeClass('selected-option');
            }
        });

    });


    //Új város felvétele
    jQuery(".new-city").on('click', function() {
        var port_id = jQuery(this).attr("attr-port");
        var xml_id = jQuery(this).attr("attr-xml");
        var wp_id = jQuery(this).attr("attr-wp");

        var tdParent = jQuery(this).parent("td");
        var backupHtml = tdParent.html();
        var tdParent2 = null;
        var backupHtml2 = '';

        var html = '<button type="button" class="add-city button ' + port_id + ' ' + xml_id + ' ' + wp_id + '" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" >Hozzáadás</button>';
        html = html + '<button type="button" class="cancel-city button ' + port_id + ' ' + xml_id + ' ' + wp_id + '" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" >Mégsem</button>';
        tdParent.html(html);

        jQuery("select").each(function() {
            if (jQuery(this).attr("attr-port") == port_id &&
                jQuery(this).attr("attr-xml") == xml_id &&
                jQuery(this).attr("attr-wp") == wp_id
            ) {

                tdParent2 = jQuery(this).parent(".select").parent('td');
                backupHtml2 = tdParent2.html();

                var table = '<table><tr><td>' +
                    '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_name" placeholder="Város neve"/>' +
                    '</td><td>' +
                    '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_lat"  placeholder="Latitude adat"/>' +
                    '</td><td>' +
                    '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_lon"  placeholder="Longitude adat"/>' +
                    '</td></tr></table>';
                tdParent2.html(table);

            }

        });

        jQuery(".cancel-city.button." + port_id + "." + xml_id + "." + wp_id).on('click', function() {
            tdParent2.html(backupHtml2);

            tdParent.html(backupHtml);
            var selectedCity = tdParent2.children("select.city");
            addEventForSelect(selectedCity);
            addEventForButton(tdParent);

        });

        jQuery(".add-city.button." + port_id + "." + xml_id + "." + wp_id).on('click', function() {

            var port_id = jQuery(this).attr("attr-port");
            var xml_id = jQuery(this).attr("attr-xml");
            var wp_id = jQuery(this).attr("attr-wp");
            var city_name = '';
            var city_lat = '';
            var city_lon = '';

            jQuery(".city_name").each(function() {
                if (jQuery(this).attr("attr-port") == port_id &&
                    jQuery(this).attr("attr-xml") == xml_id &&
                    jQuery(this).attr("attr-wp") == wp_id
                ) {
                    city_name = jQuery(this).val();
                }
            });
            jQuery(".city_lat").each(function() {
                if (jQuery(this).attr("attr-port") == port_id &&
                    jQuery(this).attr("attr-xml") == xml_id &&
                    jQuery(this).attr("attr-wp") == wp_id
                ) {
                    city_lat = jQuery(this).val();
                    city_lat = city_lat.replace('.', ',');
                }
            });
            jQuery(".city_lon").each(function() {
                if (jQuery(this).attr("attr-port") == port_id &&
                    jQuery(this).attr("attr-xml") == xml_id &&
                    jQuery(this).attr("attr-wp") == wp_id
                ) {
                    city_lon = jQuery(this).val();
                    city_lon = city_lon.replace('.', ',');
                }
            });

            jQuery.ajax({
                url: "/wp-content/plugins/boat-shortcodes/admin/ajaxSubmitNewCity.php",
                method: 'POST',
                data: {
                    'name': city_name,
                    'lat': city_lat,
                    'lon': city_lon,
                    'port': port_id,
                    'xml': xml_id,
                    'wp': wp_id
                }
            }).done(function(msg) {
                tdParent2.html(backupHtml2);
                tdParent.html(backupHtml);
                jQuery("select.city").append('<option attr-lat="' + city_lat + '" attr-lon="' + city_lon + '" value="' + msg + '">' + city_name + '</option>');
                var selectedCity = tdParent2.find("select.city").val(msg);
                selectedCity.val(msg);
                selectedCity.find("option.this").attr("selected", "selected");
                tdParent2.css('background-color', 'green');

                tdParent2.find(".selection").html("");
                tdParent2.find(".selection").removeClass("selection");
                tdParent2.find("select.city").select2();
                addEventForSelect(selectedCity);
                addEventForButton(tdParent);

            });
        });

    });
    //Város javítása
    jQuery(".repear-city").on('click', function() {
        var port_id = jQuery(this).attr("attr-port");
        var xml_id = jQuery(this).attr("attr-xml");
        var wp_id = jQuery(this).attr("attr-wp");
        var city_id = jQuery(this).attr("attr-city");
        var name = jQuery(this).attr("attr-name");
        var lon = jQuery(this).attr("attr-lon");
        var lat = jQuery(this).attr("attr-lat");

        var tdParent = jQuery(this).parent("td");
        var backupHtml = tdParent.html();
        var tdParent2 = null;
        var backupHtml2 = '';

        var html = '<button type="button" class="modify-city button ' + port_id + ' ' + xml_id + ' ' + wp_id + '" attr-port="' + port_id + '" attr-city="' + city_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" >Módosítás</button>';
        html = html + '<button type="button" class="cancel-city button ' + port_id + ' ' + xml_id + ' ' + wp_id + '" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" >Mégsem</button>';
        tdParent.html(html);

        jQuery("select").each(function() {
            if (jQuery(this).attr("attr-port") == port_id &&
                jQuery(this).attr("attr-xml") == xml_id &&
                jQuery(this).attr("attr-wp") == wp_id
            ) {

                tdParent2 = jQuery(this).parent(".select").parent('td');
                backupHtml2 = tdParent2.html();

                //tdParent.html('');
                var table = '<table><tr><td>' +
                    '<a class="google" href="https://www.google.hu/maps/place/' + name + '" target="_blank">Google</a>' +
                    '</td><td>' +
                    '<a href="https://www.latlong.net/" target="_blank">latlong</a>' +
                    '</td><td>' +
                    '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_name" value="' + name + '"/>' +
                    '</td><td>' +
                    '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_lat"  value="' + lat + '"/>' +
                    '</td><td>' +
                    '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_lon"  value="' + lon + '"/>' +
                    '</td></tr></table>';
                tdParent2.html(table);

                jQuery(".city_name").on("keyup", function() {

                    var name = jQuery(this).val();
                    var table = jQuery(this).parents('table').first();
                    var google = table.find('.google').first();

                    google.attr("href", 'https://www.google.hu/maps/place/' + name);

                });


            }
        });


        jQuery(".cancel-city.button." + port_id + "." + xml_id + "." + wp_id).on('click', function() {
            tdParent.html(backupHtml);
            tdParent2.html(backupHtml2);
            tdParent2.find(".selection").html("");
            tdParent2.find(".selection").removeClass("selection");
            var selectedCity = tdParent2.find("select.city");
            selectedCity.select2();
        });

        jQuery(".modify-city.button." + port_id + "." + xml_id + "." + wp_id).on('click', function() {

            var port_id = jQuery(this).attr("attr-port");
            var xml_id = jQuery(this).attr("attr-xml");
            var wp_id = jQuery(this).attr("attr-wp");
            var city_id = jQuery(this).attr("attr-city");
            var city_name = '';
            var city_lat = '';
            var city_lon = '';

            jQuery(".city_name").each(function() {
                if (jQuery(this).attr("attr-port") == port_id &&
                    jQuery(this).attr("attr-xml") == xml_id &&
                    jQuery(this).attr("attr-wp") == wp_id
                ) {
                    city_name = jQuery(this).val();
                }
            });
            jQuery(".city_lat").each(function() {
                if (jQuery(this).attr("attr-port") == port_id &&
                    jQuery(this).attr("attr-xml") == xml_id &&
                    jQuery(this).attr("attr-wp") == wp_id
                ) {
                    city_lat = jQuery(this).val();
                    city_lat = city_lat.replace('.', ',');
                }
            });
            jQuery(".city_lon").each(function() {
                if (jQuery(this).attr("attr-port") == port_id &&
                    jQuery(this).attr("attr-xml") == xml_id &&
                    jQuery(this).attr("attr-wp") == wp_id
                ) {
                    city_lon = jQuery(this).val();
                    city_lon = city_lon.replace('.', ',');
                }
            });

            jQuery.ajax({
                url: "/wp-content/plugins/boat-shortcodes/admin/ajaxSubmitRepearCity.php",
                method: 'POST',
                data: {
                    'city_id': city_id,
                    'name': city_name,
                    'lat': city_lat,
                    'lon': city_lon,
                    'port': port_id,
                    'xml': xml_id,
                    'wp': wp_id
                }
            }).done(function(msg) {

                tdParent2.html(backupHtml2);
                tdParent.html(backupHtml);

                jQuery("select.city").find('option').each(function() {
                    if (jQuery(this).val() == city_id) {
                        jQuery(this).attr("attr-lat", city_lat);
                        jQuery(this).attr("attr-lon", city_lon);
                        jQuery(this).html(city_name);
                    }
                });
                var selectedCity = tdParent2.find("select.city").val(city_id);
                selectedCity.val(city_id);
                tdParent2.css('background-color', 'green');

                tdParent2.find(".selection").html("");
                tdParent2.find(".selection").removeClass("selection");
                tdParent2.find("select.city").select2();
                addEventForSelect(selectedCity);
                addEventForButton(tdParent);
            });
        });

    });
    //Város javítása
    jQuery(".delete-city").on('click', function() {
        var port_id = jQuery(this).attr("attr-port");
        var xml_id = jQuery(this).attr("attr-xml");
        var wp_id = jQuery(this).attr("attr-wp");
        var city_id = jQuery(this).attr("attr-city");
        var name = jQuery(this).attr("attr-name");
        var lon = jQuery(this).attr("attr-lon");
        var lat = jQuery(this).attr("attr-lat");

        var tdParent = jQuery(this).parent("td");
        var backupHtml = tdParent.html();
        var tdParent2 = tdParent.prev("td");
        var backupHtml2 = '';

        if (confirm("Tényleg törlöd a(z) " + name + " várost?")) {
            jQuery.ajax({
                url: "/wp-content/plugins/boat-shortcodes/admin/ajaxSubmitDeleteCity.php",
                method: 'POST',
                data: {
                    'city_id': city_id
                }
            }).done(function(msg) {

                jQuery("select.city").find('option').each(function() {
                    if (jQuery(this).val() == city_id) {
                        jQuery(this).remove();
                        
                    }
                });
                tdParent2.css('background-color', 'white');
                tdParent2.find('selected.city').removeClass('selected-option');
                tdParent2.find('selected.city').val(0);

                jQuery("selected.city").parent("td").find(".section").html("");
                jQuery("selected.city").parent("td").find(".section").remove();
                //jQuery("selected.city").parent("td").find(".section").removeClass("section");
                jQuery("selected.city").select2();
            });
        }

    });


    /************************************************ */
    function addEventForSelect(selectedCity) {
        selectedCity.on("change", function() {
            var city = jQuery(this).val();
            var lat = 0;
            var lon = 0;
            var html = "0";
            var options = jQuery(this).children("option");
            options.each(function() {
                if (city == jQuery(this).attr("value")) {
                    lat = jQuery(this).attr("attr-lat");
                    lon = jQuery(this).attr("attr-lon");
                    html = jQuery(this).html();

                }
            });
            var repear = jQuery(this).parents("td").first().next().children(".repear-city").first();
            repear.attr("attr-city", city);
            repear.attr("attr-lat", lat);
            repear.attr("attr-lon", lon);
            repear.attr("attr-name", html);

            var delete_ = jQuery(this).parents("td").first().next().children(".delete-city").first();
            delete_.attr("attr-city", city);
            delete_.attr("attr-lat", lat);
            delete_.attr("attr-lon", lon);
            delete_.attr("attr-name", html);

        });
    }

    function addEventForButton(tdParent) {

        //Város jóváhagyása
        var submitCity = tdParent.children(".submit-city");
        submitCity.on('click', function() {
            var port_id = jQuery(this).attr("attr-port");
            var xml_id = jQuery(this).attr("attr-xml");
            var wp_id = jQuery(this).attr("attr-wp");
            var city_id = 0;
            var selectedOption = null;
            jQuery("select").each(function() {

                if (jQuery(this).attr("attr-port") == port_id &&
                    jQuery(this).attr("attr-xml") == xml_id &&
                    jQuery(this).attr("attr-wp") == wp_id
                ) {
                    city_id = jQuery(this).val();
                    selectedOption = jQuery(this);
                }
            });
            if (city_id > 0) {

                jQuery.ajax({
                    url: "/wp-content/plugins/boat-shortcodes/admin/ajaxSubmitCity.php",
                    method: 'POST',
                    data: {
                        'city': city_id,
                        'port': port_id,
                        'xml': xml_id,
                        'wp': wp_id
                    }
                }).done(function(msg) {
                    console.log(msg);
                    if (msg == 1) {
                        selectedOption.addClass('selected-option');
                        console.log(selectedOption.parent().find('select2-selection__rendered'));
                        selectedOption.parent().find('select2-selection__rendered').addClass('selected-option');
                        selectedOption.parents('td').css('background-color', 'green');

                    } else {
                        alert(msg);
                    }

                });
            }

        });
        jQuery("select.city").trigger("change");
        //Alaphelyzetbe állítás
        var resetCity = tdParent.children(".reset-city");
        resetCity.on('click', function() {
            var port_id = jQuery(this).attr("attr-port");
            var xml_id = jQuery(this).attr("attr-xml");
            var wp_id = jQuery(this).attr("attr-wp");
            var resetButton = jQuery(this);

            jQuery.ajax({
                url: "/wp-content/plugins/boat-shortcodes/admin/ajaxResetCity.php",
                method: 'POST',
                data: {
                    'port': port_id,
                    'xml': xml_id,
                    'wp': wp_id,
                    'who': 'xml'
                }
            }).done(function(msg) {
                if (msg == 1) {
                    console.log(resetButton.parents('tr').find('td'));
                    resetButton.parents('tr').find('td').css('background-color', 'white');
                    console.log(resetButton.parents('tr').find('.selected-option'));
                    resetButton.parents('tr').find('.selected-option').removeClass('selected-option');
                }
            });

        });


        //Új város felvétele
        var newCity = tdParent.children(".new-city");
        newCity.on('click', function() {
            var port_id = jQuery(this).attr("attr-port");
            var xml_id = jQuery(this).attr("attr-xml");
            var wp_id = jQuery(this).attr("attr-wp");

            var tdParent = jQuery(this).parent("td");
            var backupHtml = tdParent.html();
            var html = '<button type="button" class="add-city button ' + port_id + ' ' + xml_id + ' ' + wp_id + '" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" >Hozzáadás</button>';
            html = html + '<button type="button" class="cancel-city button ' + port_id + ' ' + xml_id + ' ' + wp_id + '" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" >Mégsem</button>';
            tdParent.html(html);

            var tdParent2 = null;
            var backupHtml2 = '';
            jQuery("select").each(function() {
                if (jQuery(this).attr("attr-port") == port_id &&
                    jQuery(this).attr("attr-xml") == xml_id &&
                    jQuery(this).attr("attr-wp") == wp_id
                ) {

                    tdParent2 = jQuery(this).parent(".select").parent('td');
                    backupHtml2 = tdParent2.html();
                    tdParent2.html('');
                    var table = '<table><tr><td>' +
                        '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_name" placeholder="Város neve"/>' +
                        '</td><td>' +
                        '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_lat"  placeholder="Latitude adat"/>' +
                        '</td><td>' +
                        '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_lon"  placeholder="Longitude adat"/>' +
                        '</td></tr></table>';
                    tdParent2.html(table);

                }

            });

            jQuery(".cancel-city.button." + port_id + "." + xml_id + "." + wp_id).on('click', function() {

                tdParent2.html(backupHtml2);
                tdParent.html(backupHtml);
                var selectedCity = tdParent2.children("select.city");
                addEventForSelect(selectedCity);
                addEventForButton(tdParent);

            });

            jQuery(".add-city.button." + port_id + "." + xml_id + "." + wp_id).on('click', function() {

                var port_id = jQuery(this).attr("attr-port");
                var xml_id = jQuery(this).attr("attr-xml");
                var wp_id = jQuery(this).attr("attr-wp");
                var city_name = '';
                var city_lat = '';
                var city_lon = '';

                jQuery(".city_name").each(function() {
                    if (jQuery(this).attr("attr-port") == port_id &&
                        jQuery(this).attr("attr-xml") == xml_id &&
                        jQuery(this).attr("attr-wp") == wp_id
                    ) {
                        city_name = jQuery(this).val();
                    }
                });
                jQuery(".city_lat").each(function() {
                    if (jQuery(this).attr("attr-port") == port_id &&
                        jQuery(this).attr("attr-xml") == xml_id &&
                        jQuery(this).attr("attr-wp") == wp_id
                    ) {
                        city_lat = jQuery(this).val();
                        city_lat = city_lat.replace('.', ',');
                    }
                });
                jQuery(".city_lon").each(function() {
                    if (jQuery(this).attr("attr-port") == port_id &&
                        jQuery(this).attr("attr-xml") == xml_id &&
                        jQuery(this).attr("attr-wp") == wp_id
                    ) {
                        city_lon = jQuery(this).val();
                        city_lon = city_lon.replace('.', ',');
                    }
                });

                jQuery.ajax({
                    url: "/wp-content/plugins/boat-shortcodes/admin/ajaxSubmitNewCity.php",
                    method: 'POST',
                    data: {
                        'name': city_name,
                        'lat': city_lat,
                        'lon': city_lon,
                        'port': port_id,
                        'xml': xml_id,
                        'wp': wp_id
                    }
                }).done(function(msg) {
                    tdParent2.html(backupHtml2);
                    tdParent.html(backupHtml);
                    jQuery("select.city").append('<option class="this" attr-lat="' + city_lat + '" attr-lon="' + city_lon + '" value="' + msg + '">' + city_name + '</option>');
                    var selectedCity = tdParent2.find("select.city").val(msg);
                    selectedCity.find("option.this").attr("selected", "selected");
                    tdParent2.css('background-color', 'green');
                    tdParent2.find(".selection").html("");
                    tdParent2.find(".selection").removeClass("selection");
                    selectedCity.select2();
                });
            });

        });
        //Város javítása
        var repearCity = tdParent.children(".repear-city");
        repearCity.on('click', function() {
            var port_id = jQuery(this).attr("attr-port");
            var xml_id = jQuery(this).attr("attr-xml");
            var wp_id = jQuery(this).attr("attr-wp");
            var city_id = jQuery(this).attr("attr-city");
            var name = jQuery(this).attr("attr-name");
            var lon = jQuery(this).attr("attr-lon");
            var lat = jQuery(this).attr("attr-lat");
            var tdParent = jQuery(this).parent("td");
            var backupHtml = tdParent.html();
            var tdParent2 = null;
            var backupHtml2 = '';

            var html = '<button type="button" class="modify-city button ' + port_id + ' ' + xml_id + ' ' + wp_id + '" attr-port="' + port_id + '" attr-city="' + city_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" >Módosítás</button>';
            html = html + '<button type="button" class="cancel-city button ' + port_id + ' ' + xml_id + ' ' + wp_id + '" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" >Mégsem</button>';
            tdParent.html(html);

            jQuery("select").each(function() {
                if (jQuery(this).attr("attr-port") == port_id &&
                    jQuery(this).attr("attr-xml") == xml_id &&
                    jQuery(this).attr("attr-wp") == wp_id
                ) {

                    tdParent2 = jQuery(this).parent(".select").parent('td');
                    backupHtml2 = tdParent2.html();

                    //tdParent.html('');
                    var table = '<table><tr><td>' +
                        '<a class="google" href="https://www.google.hu/maps/place/' + name + '" target="_blank">Google</a>' +
                        '</td><td>' +
                        '<a href="https://www.latlong.net/" target="_blank">latlong</a>' +
                        '</td><td>' +
                        '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_name" value="' + name + '"/>' +
                        '</td><td>' +
                        '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_lat"  value="' + lat + '"/>' +
                        '</td><td>' +
                        '<input type="text" attr-port="' + port_id + '" attr-xml="' + xml_id + '" attr-wp="' + wp_id + '" class="city_lon"  value="' + lon + '"/>' +
                        '</td></tr></table>';
                    tdParent2.html(table);

                    jQuery(".city_name").on("keyup", function() {

                        var name = jQuery(this).val();
                        var table = jQuery(this).parents('table').first();
                        var google = table.find('.google').first();

                        google.attr("href", 'https://www.google.hu/maps/place/' + name);

                    });


                }
            });


            jQuery(".cancel-city.button." + port_id + "." + xml_id + "." + wp_id).on('click', function() {
                tdParent.html(backupHtml);
                tdParent2.html(backupHtml2);
                tdParent2.find(".selection").html("");
                tdParent2.find(".selection").removeClass("selection");
                var selectedCity = tdParent2.find("select.city");
                selectedCity.select2();
            });

            jQuery(".modify-city.button." + port_id + "." + xml_id + "." + wp_id).on('click', function() {

                var port_id = jQuery(this).attr("attr-port");
                var xml_id = jQuery(this).attr("attr-xml");
                var wp_id = jQuery(this).attr("attr-wp");
                var city_id = jQuery(this).attr("attr-city");
                var city_name = '';
                var city_lat = '';
                var city_lon = '';

                jQuery(".city_name").each(function() {
                    if (jQuery(this).attr("attr-port") == port_id &&
                        jQuery(this).attr("attr-xml") == xml_id &&
                        jQuery(this).attr("attr-wp") == wp_id
                    ) {
                        city_name = jQuery(this).val();
                    }
                });
                jQuery(".city_lat").each(function() {
                    if (jQuery(this).attr("attr-port") == port_id &&
                        jQuery(this).attr("attr-xml") == xml_id &&
                        jQuery(this).attr("attr-wp") == wp_id
                    ) {
                        city_lat = jQuery(this).val();
                        city_lat = city_lat.replace('.', ',');
                    }
                });
                jQuery(".city_lon").each(function() {
                    if (jQuery(this).attr("attr-port") == port_id &&
                        jQuery(this).attr("attr-xml") == xml_id &&
                        jQuery(this).attr("attr-wp") == wp_id
                    ) {
                        city_lon = jQuery(this).val();
                        city_lon = city_lon.replace('.', ',');
                    }
                });

                jQuery.ajax({
                    url: "/wp-content/plugins/boat-shortcodes/admin/ajaxSubmitRepearCity.php",
                    method: 'POST',
                    data: {
                        'city_id': city_id,
                        'name': city_name,
                        'lat': city_lat,
                        'lon': city_lon,
                        'port': port_id,
                        'xml': xml_id,
                        'wp': wp_id
                    }
                }).done(function(msg) {
                    tdParent2.html(backupHtml2);
                    tdParent.html(backupHtml);

                    jQuery("select.city").find('option').each(function() {
                        if (jQuery(this).val() == city_id) {
                            jQuery(this).attr("attr-lat", city_lat);
                            jQuery(this).attr("attr-lon", city_lon);
                            jQuery(this).html(city_name);
                        }
                    });
                    var selectedCity = tdParent2.find("select.city").val(city_id);
                    selectedCity.val(city_id);
                    tdParent2.css('background-color', 'green');

                    tdParent2.find(".selection").html("");
                    tdParent2.find(".selection").removeClass("selection");
                    tdParent2.find("select.city").select2();
                    addEventForSelect(selectedCity);
                    addEventForButton(tdParent);
                });
            });

        });
        //Város javítása
        var deleteCity = tdParent.children(".delete-city");
        deleteCity.on('click', function() {
            var port_id = jQuery(this).attr("attr-port");
            var xml_id = jQuery(this).attr("attr-xml");
            var wp_id = jQuery(this).attr("attr-wp");
            var city_id = jQuery(this).attr("attr-city");
            var name = jQuery(this).attr("attr-name");
            var lon = jQuery(this).attr("attr-lon");
            var lat = jQuery(this).attr("attr-lat");

            var tdParent = jQuery(this).parent("td");
            var backupHtml = tdParent.html();
            var tdParent2 = tdParent.prev("td");
            var backupHtml2 = '';

            if (confirm("Tényleg törlöd a(z) " + name + " várost?")) {
                jQuery.ajax({
                    url: "/wp-content/plugins/boat-shortcodes/admin/ajaxSubmitDeleteCity.php",
                    method: 'POST',
                    data: {
                        'city_id': city_id
                    }
                }).done(function(msg) {

                    jQuery("select.city").find('option').each(function() {
                        if (jQuery(this).val() == city_id) {
                            jQuery(this).remove();
                        }
                    });

                    tdParent2.css('background-color', 'white');
                    tdParent2.find('selected.city').removeClass('selected-option');
                    tdParent2.find('selected.city').val(0);
                    jQuery("selected.city").parent("td").find(".section").html("");
                    jQuery("selected.city").parent("td").find(".section").remove();
                    //jQuery("selected.city").parent("td").find(".section").removeClass("section");
                    jQuery("selected.city").select2();
                });
            }

        });

    }
</script>